Fmin = ifelse(
!is.na(Hmax) & Hmax > 0 & Hmax <= 0.5 & is.na(Fmin) | grepl('^H',Habit), Hmin, Fmin))
Com.Sp.hts <- obsspp %>% group_by(Observation_Label, AcTaxon, Simple) %>%
summarise(
Fmin=mean(Fmin, na.rm=T),
Fmax=mean(Fmax, na.rm=T),
Smin=mean(Smin, na.rm=T),
Smax=mean(Smax, na.rm=T),
SCmin=mean(SCmin, na.rm=T),
SCmax=mean(SCmax, na.rm=T),
Tmin=mean(Tmin, na.rm=T),
Tmax=mean(Tmax, na.rm=T),
Dmin=mean(Dmin, na.rm=T),
Dmax=mean(Dmax, na.rm=T)
)
Com.Sp.mean <- Com.Sp.mean %>% left_join(Com.Sp.hts, by=c('Observation_Label'='Observation_Label', 'Species'='AcTaxon', 'Simple'='Simple'))
#ensure not to exceed 100%
Com.Sp.mean$Field <- ifelse(Com.Sp.mean$Field > 100,100,Com.Sp.mean$Field)
Com.Sp.mean$Shrub <- ifelse(Com.Sp.mean$Shrub > 100,100,Com.Sp.mean$Shrub)
Com.Sp.mean$Subcanopy <- ifelse(Com.Sp.mean$Subcanopy > 100,100,Com.Sp.mean$Subcanopy)
Com.Sp.mean$Tree <- ifelse(Com.Sp.mean$Tree > 100,100,Com.Sp.mean$Tree)
#average overstory and understory
Com.Sp.mean$Total <- 100*(1-10^(apply(log10(1-(Com.Sp.mean[,c('Field', 'Shrub', 'Subcanopy', 'Tree')]/100.001)), MARGIN = 1, FUN='sum')))
Com.Sp.mean <-subset(Com.Sp.mean, !substr(Species,1,1) %in% '-'& !Species %in% '')
##hand picked phases ----
groups1 <- as.data.frame(cbind(soilplot=names(groups), phase=groups))
Com.Sp.groups <- merge(groups1, Com.Sp.mean, by='soilplot')
Com.Sp.groups.sum
Com.Sp.groups
groups1
groups
#run separate open vs forest analyses
newnames <- paste0('t',str_pad(round(overstorycover$overstorycover, 0), 2,'left',0),'s',str_pad(round(overstorycover$shrubcover, 0), 2,'left',0), overstorycover$soilplot)
plotdatax <- plotdata
rownames(plotdatax) <- newnames
shrubplots <- subset(overstorycover, shrubcover >= 10 & overstorycover < 10)$soilplot
plotdata.shrub <- subset(plotdata, rownames(plotdata) %in%  shrubplots )
openplots <- subset(overstorycover, shrubcover < 10 & overstorycover < 10)$soilplot
plotdata.open <- subset(plotdata, rownames(plotdata) %in%  openplots )
openplots <- subset(overstorycover, shrubcover < 10 & overstorycover < 10)$soilplot
plotdata.open <- subset(plotdata, rownames(plotdata) %in%  c(openplots,shrubplots) )
forestplots <- subset(overstorycover, overstorycover >= 10)$soilplot
plotdata.forest <- subset(plotdata, rownames(plotdata) %in%  forestplots )
plotdata.open.normal <- cleanplotdata(plotdata.open)
plotdata.forest.normal <- cleanplotdata(plotdata.forest)
timeA = Sys.time()
indob <- indanalysis2(plotdata.open.normal)
Sys.time() - timeA
open.ind.table <- indob[[1]]
open.dni.table <- indob[[2]]
open.weak.table <- indob[[3]]
open.kaew.table <- indob[[4]]
Sys.time() - timeA
timeA = Sys.time()
indob <- indanalysis2(plotdata.forest.normal)
Sys.time() - timeA
forest.ind.table <- indob[[1]]
forest.dni.table <- indob[[2]]
forest.weak.table <- indob[[3]]
forest.kaew.table <- indob[[4]]
Sys.time() - timeA
#forest ----
p1=plotdata.forest.normal
d <- vegdist(p1, method='bray', binary=FALSE, na.rm=T)
k = 5
t  <- d %>% flexbeta(beta= -0.15) %>% as.hclust() %>% dendsort()
groups <- cutree(t, k = k)
groups <- grouporder(t, groups)
if (T){
a <- 'forest'
makeplotgroup(a,d,t,groups)
}
indicators <- indgroup(p1, groups, F)
indicators2 <- indgroup2(p1, groups, F)
iplot <- indicators2[[1]]
gplot <- indicators2[[2]]
aplot <- indicators2[[3]]
source('groupplotsummary.R')
source('USNVC_compare_specieslists_loop_by_cluster.R')
Com.Structure[order(as.numeric(as.character(Com.Structure$cluster))),c("cluster", "association", "WetStructure")]
plotassociations[order(as.numeric(as.character(plotassociations$clust))),c("clust", "scientificname")]
substitutesymbols <- as.data.frame(cbind(SYMBOL2=c('2AG','TRBO2','SMLA3','CAREX'), form2=c('Nonvascular','Forb/Herb','Forb/Herb','Grass/grass-like (Graminoids)'), type2=c('Native','Native','Native','Native'), taxon=c('Chara','Lysimachia borealis','Smilax lasioneuron','Carex [ovales]')), stringsAsFactors = FALSE)
# data ----
Plant_Heights <- read.delim("data/Plant_Heights.txt", na.strings = '', stringsAsFactors = FALSE, encoding = 'UTF-8')
# # observed species means by plot ----
# Com.Sp.sum<-aggregate(obsspp[,c('Field', 'Shrub', 'Subcanopy', 'Tree', 'BA')], by=list(obsspp$Observation_ID, obsspp$Observation_Label, obsspp$AcTaxon, obsspp$Simple), FUN=sum) #sum within plot
# colnames(Com.Sp.sum)<-c('Observation_ID', 'Observation_Label', 'Species', 'Simple', 'Field', 'Shrub', 'Subcanopy', 'Tree', 'BA') #restore column names
# # freq in subplot ----
# Com.Sp.freq<-aggregate(obsspp[,c('AcTaxon')], by=list(obsspp$Observation_Label, obsspp$AcTaxon), FUN=length) #frequency within plot
# colnames(Com.Sp.freq)<- c('Observation_Label', 'Species', 'freq')
# Com.max.freq<-aggregate(Com.Sp.freq[,c('freq')], by=list(Com.Sp.freq$Observation_Label), FUN=max) #freq within plot
# colnames(Com.max.freq)<- c('Observation_Label', 'mfreq')
# Com.max.freq$mfreq<-ifelse(Com.max.freq$mfreq>4,4,Com.max.freq$mfreq)#effectively ensuring values do not exceed 4. Species listed 5 times might occur if surveyer was unaware of species already counted in subplots, but this only adds a trace amount.
# Com.Sp.mean<-merge(Com.Sp.sum, Com.max.freq[,c("Observation_Label","mfreq")], by="Observation_Label")
# Com.Sp.mean$Field<-Com.Sp.mean$Field/Com.Sp.mean$mfreq
# Com.Sp.mean$Shrub<-Com.Sp.mean$Shrub/Com.Sp.mean$mfreq
# Com.Sp.mean$Subcanopy<-Com.Sp.mean$Subcanopy/Com.Sp.mean$mfreq
# Com.Sp.mean$Tree<-Com.Sp.mean$Tree/Com.Sp.mean$mfreq
# rm(Com.max.freq)
# heights ----
#transfer canopy heights to appropriate stratum
#
obsspp <- obsspp %>% mutate(
Tmax = ifelse(
!is.na(Hmax) & Hmax > 15 & is.na(Tmax) & !grepl('^H',Habit), Hmax, Tmax),
Tmin = ifelse(
!is.na(Hmax) & Hmax > 15 & is.na(Tmin) & !grepl('^H',Habit), Hmin, Tmin),
SCmax = ifelse(
!is.na(Hmax) & Hmax > 5 & Hmax <= 15 & is.na(SCmax) & !grepl('^H',Habit), Hmax, SCmax),
SCmin = ifelse(
!is.na(Hmax) & Hmax > 5 & Hmax <= 15 & is.na(SCmin) & !grepl('^H',Habit), Hmin, SCmin),
Smax = ifelse(
!is.na(Hmax) & Hmax > 0.5 & Hmax <= 5 & is.na(Smax) & !grepl('^H',Habit), Hmax, Smax),
Smin = ifelse(
!is.na(Hmax) & Hmax > 0.5 & Hmax <= 5 & is.na(Smin) & !grepl('^H',Habit), Hmin, Smin),
Fmax = ifelse(
!is.na(Hmax) & Hmax > 0 & Hmax <= 0.5 & is.na(Fmax) | grepl('^H',Habit), Hmax, Fmax),
Fmin = ifelse(
!is.na(Hmax) & Hmax > 0 & Hmax <= 0.5 & is.na(Fmin) | grepl('^H',Habit), Hmin, Fmin))
Com.Sp.hts <- obsspp %>% group_by(Observation_Label, AcTaxon, Simple) %>%
summarise(
Fmin=mean(Fmin, na.rm=T),
Fmax=mean(Fmax, na.rm=T),
Smin=mean(Smin, na.rm=T),
Smax=mean(Smax, na.rm=T),
SCmin=mean(SCmin, na.rm=T),
SCmax=mean(SCmax, na.rm=T),
Tmin=mean(Tmin, na.rm=T),
Tmax=mean(Tmax, na.rm=T),
Dmin=mean(Dmin, na.rm=T),
Dmax=mean(Dmax, na.rm=T)
)
Com.Sp.mean <- Com.Sp.mean %>% left_join(Com.Sp.hts, by=c('Observation_Label'='Observation_Label', 'Species'='AcTaxon', 'Simple'='Simple'))
#ensure not to exceed 100%
Com.Sp.mean$Field <- ifelse(Com.Sp.mean$Field > 100,100,Com.Sp.mean$Field)
Com.Sp.mean$Shrub <- ifelse(Com.Sp.mean$Shrub > 100,100,Com.Sp.mean$Shrub)
Com.Sp.mean$Subcanopy <- ifelse(Com.Sp.mean$Subcanopy > 100,100,Com.Sp.mean$Subcanopy)
Com.Sp.mean$Tree <- ifelse(Com.Sp.mean$Tree > 100,100,Com.Sp.mean$Tree)
#average overstory and understory
Com.Sp.mean$Total <- 100*(1-10^(apply(log10(1-(Com.Sp.mean[,c('Field', 'Shrub', 'Subcanopy', 'Tree')]/100.001)), MARGIN = 1, FUN='sum')))
Com.Sp.mean <-subset(Com.Sp.mean, !substr(Species,1,1) %in% '-'& !Species %in% '')
##hand picked phases ----
groups1 <- as.data.frame(cbind(soilplot=names(groups), phase=groups))
Com.Sp.groups <- merge(groups1, Com.Sp.mean, by='soilplot')
Com.Sp.groups
Com.Sp.groups.sum <- aggregate(Com.Sp.groups[,c('Field', 'Shrub', 'Subcanopy','Tree', 'Total')],
by=list(Com.Sp.groups$phase, Com.Sp.groups$Species), FUN='sum')
colnames(Com.Sp.groups.sum) <- c('phase', 'Species', 'Field', 'Shrub', 'Subcanopy','Tree', 'Total')
unique(Com.Sp.groups[c('phase', 'Observation_ID')])$Observation_ID
unique(Com.Sp.groups[c('phase', 'Observation_ID')])$phase
Com.Sp.groups.count <- aggregate(unique(Com.Sp.groups[c('phase', 'Observation_ID')])$Observation_ID,
by=list(unique(Com.Sp.groups[c('phase', 'Observation_ID')])$phase), FUN='length')
colnames(Com.Sp.groups.count) <- c('phase', 'count')
Com.Sp.groups.mean <- merge(Com.Sp.groups.sum, Com.Sp.groups.count, by = 'phase')
Com.Sp.groups.mean[,c('Field', 'Shrub', 'Subcanopy','Tree', 'Total')] <- Com.Sp.groups.mean[,c('Field', 'Shrub', 'Subcanopy','Tree', 'Total')]/Com.Sp.groups.mean$count
rm(Com.Sp.groups.sum, Com.Sp.groups.count)
# aggregated total overstory and understory for species ranking
Com.Sp.groups.mean$over <- 100*(1-10^(apply(log10(1-(Com.Sp.groups.mean[,c('Subcanopy', 'Tree')]/100.001)), MARGIN = 1, FUN='sum')))
Com.Sp.groups.mean$under <- 100*(1-10^(apply(log10(1-(Com.Sp.groups.mean[,c('Field', 'Shrub')]/100.001)), MARGIN = 1, FUN='sum')))
Com.Sp.groups.hts <- Com.Sp.groups %>% group_by(phase, Species, Simple) %>%
summarise(
Fmin=mean(Fmin, na.rm=T),
Fmax=mean(Fmax, na.rm=T),
Smin=mean(Smin, na.rm=T),
Smax=mean(Smax, na.rm=T),
SCmin=mean(SCmin, na.rm=T),
SCmax=mean(SCmax, na.rm=T),
Tmin=mean(Tmin, na.rm=T),
Tmax=mean(Tmax, na.rm=T),
Dmin=mean(Dmin, na.rm=T),
Dmax=mean(Dmax, na.rm=T)
)
View(Com.Sp.Agg.groups.mean)
View(Com.Sp.Agg.groups)
View(Com.Sp.groups)
substitutesymbols <- as.data.frame(cbind(SYMBOL2=c('2AG','TRBO2','SMLA3','CAREX'), form2=c('Nonvascular','Forb/Herb','Forb/Herb','Grass/grass-like (Graminoids)'), type2=c('Native','Native','Native','Native'), taxon=c('Chara','Lysimachia borealis','Smilax lasioneuron','Carex [ovales]')), stringsAsFactors = FALSE)
# data ----
Plant_Heights <- read.delim("data/Plant_Heights.txt", na.strings = '', stringsAsFactors = FALSE, encoding = 'UTF-8')
# # observed species means by plot ----
# Com.Sp.sum<-aggregate(obsspp[,c('Field', 'Shrub', 'Subcanopy', 'Tree', 'BA')], by=list(obsspp$Observation_ID, obsspp$Observation_Label, obsspp$AcTaxon, obsspp$Simple), FUN=sum) #sum within plot
# colnames(Com.Sp.sum)<-c('Observation_ID', 'Observation_Label', 'Species', 'Simple', 'Field', 'Shrub', 'Subcanopy', 'Tree', 'BA') #restore column names
# # freq in subplot ----
# Com.Sp.freq<-aggregate(obsspp[,c('AcTaxon')], by=list(obsspp$Observation_Label, obsspp$AcTaxon), FUN=length) #frequency within plot
# colnames(Com.Sp.freq)<- c('Observation_Label', 'Species', 'freq')
# Com.max.freq<-aggregate(Com.Sp.freq[,c('freq')], by=list(Com.Sp.freq$Observation_Label), FUN=max) #freq within plot
# colnames(Com.max.freq)<- c('Observation_Label', 'mfreq')
# Com.max.freq$mfreq<-ifelse(Com.max.freq$mfreq>4,4,Com.max.freq$mfreq)#effectively ensuring values do not exceed 4. Species listed 5 times might occur if surveyer was unaware of species already counted in subplots, but this only adds a trace amount.
# Com.Sp.mean<-merge(Com.Sp.sum, Com.max.freq[,c("Observation_Label","mfreq")], by="Observation_Label")
# Com.Sp.mean$Field<-Com.Sp.mean$Field/Com.Sp.mean$mfreq
# Com.Sp.mean$Shrub<-Com.Sp.mean$Shrub/Com.Sp.mean$mfreq
# Com.Sp.mean$Subcanopy<-Com.Sp.mean$Subcanopy/Com.Sp.mean$mfreq
# Com.Sp.mean$Tree<-Com.Sp.mean$Tree/Com.Sp.mean$mfreq
# rm(Com.max.freq)
# heights ----
#transfer canopy heights to appropriate stratum
#
obsspp <- obsspp %>% mutate(
Tmax = ifelse(
!is.na(Hmax) & Hmax > 15 & is.na(Tmax) & !grepl('^H',Habit), Hmax, Tmax),
Tmin = ifelse(
!is.na(Hmax) & Hmax > 15 & is.na(Tmin) & !grepl('^H',Habit), Hmin, Tmin),
SCmax = ifelse(
!is.na(Hmax) & Hmax > 5 & Hmax <= 15 & is.na(SCmax) & !grepl('^H',Habit), Hmax, SCmax),
SCmin = ifelse(
!is.na(Hmax) & Hmax > 5 & Hmax <= 15 & is.na(SCmin) & !grepl('^H',Habit), Hmin, SCmin),
Smax = ifelse(
!is.na(Hmax) & Hmax > 0.5 & Hmax <= 5 & is.na(Smax) & !grepl('^H',Habit), Hmax, Smax),
Smin = ifelse(
!is.na(Hmax) & Hmax > 0.5 & Hmax <= 5 & is.na(Smin) & !grepl('^H',Habit), Hmin, Smin),
Fmax = ifelse(
!is.na(Hmax) & Hmax > 0 & Hmax <= 0.5 & is.na(Fmax) | grepl('^H',Habit), Hmax, Fmax),
Fmin = ifelse(
!is.na(Hmax) & Hmax > 0 & Hmax <= 0.5 & is.na(Fmin) | grepl('^H',Habit), Hmin, Fmin))
Com.Sp.hts <- obsspp %>% group_by(Observation_Label, AcTaxon, Simple) %>%
summarise(
Fmin=mean(Fmin, na.rm=T),
Fmax=mean(Fmax, na.rm=T),
Smin=mean(Smin, na.rm=T),
Smax=mean(Smax, na.rm=T),
SCmin=mean(SCmin, na.rm=T),
SCmax=mean(SCmax, na.rm=T),
Tmin=mean(Tmin, na.rm=T),
Tmax=mean(Tmax, na.rm=T),
Dmin=mean(Dmin, na.rm=T),
Dmax=mean(Dmax, na.rm=T)
)
Com.Sp.mean <- Com.Sp.mean %>% left_join(Com.Sp.hts, by=c('Observation_Label'='Observation_Label', 'Species'='AcTaxon', 'Simple'='Simple'))
#ensure not to exceed 100%
Com.Sp.mean$Field <- ifelse(Com.Sp.mean$Field > 100,100,Com.Sp.mean$Field)
Com.Sp.mean$Shrub <- ifelse(Com.Sp.mean$Shrub > 100,100,Com.Sp.mean$Shrub)
Com.Sp.mean$Subcanopy <- ifelse(Com.Sp.mean$Subcanopy > 100,100,Com.Sp.mean$Subcanopy)
Com.Sp.mean$Tree <- ifelse(Com.Sp.mean$Tree > 100,100,Com.Sp.mean$Tree)
#average overstory and understory
Com.Sp.mean$Total <- 100*(1-10^(apply(log10(1-(Com.Sp.mean[,c('Field', 'Shrub', 'Subcanopy', 'Tree')]/100.001)), MARGIN = 1, FUN='sum')))
Com.Sp.mean <-subset(Com.Sp.mean, !substr(Species,1,1) %in% '-'& !Species %in% '')
##hand picked phases ----
groups1 <- as.data.frame(cbind(soilplot=names(groups), phase=groups))
Com.Sp.groups <- merge(groups1, Com.Sp.mean, by='soilplot')
##average spp by phase ----
Com.Sp.groups.sum <- aggregate(Com.Sp.groups[,c('Field', 'Shrub', 'Subcanopy','Tree', 'Total')],
by=list(Com.Sp.groups$phase, Com.Sp.groups$Species), FUN='sum')
colnames(Com.Sp.groups.sum) <- c('phase', 'Species', 'Field', 'Shrub', 'Subcanopy','Tree', 'Total')
Com.Sp.groups.count <- aggregate(unique(Com.Sp.groups[c('phase', 'Observation_ID')])$Observation_ID,
by=list(unique(Com.Sp.groups[c('phase', 'Observation_ID')])$phase), FUN='length')
colnames(Com.Sp.groups.count) <- c('phase', 'count')
Com.Sp.groups.mean <- merge(Com.Sp.groups.sum, Com.Sp.groups.count, by = 'phase')
Com.Sp.groups.mean[,c('Field', 'Shrub', 'Subcanopy','Tree', 'Total')] <- Com.Sp.groups.mean[,c('Field', 'Shrub', 'Subcanopy','Tree', 'Total')]/Com.Sp.groups.mean$count
rm(Com.Sp.groups.sum, Com.Sp.groups.count)
# aggregated total overstory and understory for species ranking
Com.Sp.groups.mean$over <- 100*(1-10^(apply(log10(1-(Com.Sp.groups.mean[,c('Subcanopy', 'Tree')]/100.001)), MARGIN = 1, FUN='sum')))
Com.Sp.groups.mean$under <- 100*(1-10^(apply(log10(1-(Com.Sp.groups.mean[,c('Field', 'Shrub')]/100.001)), MARGIN = 1, FUN='sum')))
library(soilDB)
library(aqp)#load before dplyr
library(stringr)
library(BiodiversityR)
library(cluster)
library(ape)
library(dendextend)
library(dplyr)
library(dynamicTreeCut)
library(rpart)
library(rpart.plot)
library(goeveg)
library(proxy)
library(foreign)
library(optpart)
library(dendsort)
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
#load clustering functions ----
source('clusterfunctions.R')
# Load Veg tables ----
source('processplot.R')
#run separate open vs forest analyses
newnames <- paste0('t',str_pad(round(overstorycover$overstorycover, 0), 2,'left',0),'s',str_pad(round(overstorycover$shrubcover, 0), 2,'left',0), overstorycover$soilplot)
plotdatax <- plotdata
rownames(plotdatax) <- newnames
shrubplots <- subset(overstorycover, shrubcover >= 10 & overstorycover < 10)$soilplot
plotdata.shrub <- subset(plotdata, rownames(plotdata) %in%  shrubplots )
openplots <- subset(overstorycover, shrubcover < 10 & overstorycover < 10)$soilplot
plotdata.open <- subset(plotdata, rownames(plotdata) %in%  openplots )
openplots <- subset(overstorycover, shrubcover < 10 & overstorycover < 10)$soilplot
plotdata.open <- subset(plotdata, rownames(plotdata) %in%  c(openplots,shrubplots) )
forestplots <- subset(overstorycover, overstorycover >= 10)$soilplot
plotdata.forest <- subset(plotdata, rownames(plotdata) %in%  forestplots )
plotdata.open.normal <- cleanplotdata(plotdata.open)
plotdata.forest.normal <- cleanplotdata(plotdata.forest)
timeA = Sys.time()
indob <- indanalysis2(plotdata.open.normal)
Sys.time() - timeA
open.ind.table <- indob[[1]]
open.dni.table <- indob[[2]]
open.weak.table <- indob[[3]]
open.kaew.table <- indob[[4]]
Sys.time() - timeA
timeA = Sys.time()
indob <- indanalysis2(plotdata.forest.normal)
Sys.time() - timeA
forest.ind.table <- indob[[1]]
forest.dni.table <- indob[[2]]
forest.weak.table <- indob[[3]]
forest.kaew.table <- indob[[4]]
Sys.time() - timeA
#forest ----
p1=plotdata.forest.normal
d <- vegdist(p1, method='bray', binary=FALSE, na.rm=T)
k = 5
t  <- d %>% flexbeta(beta= -0.15) %>% as.hclust() %>% dendsort()
groups <- cutree(t, k = k)
groups <- grouporder(t, groups)
if (T){
a <- 'forest'
makeplotgroup(a,d,t,groups)
}
indicators <- indgroup(p1, groups, F)
indicators2 <- indgroup2(p1, groups, F)
iplot <- indicators2[[1]]
gplot <- indicators2[[2]]
aplot <- indicators2[[3]]
source('groupplotsummary.R')
source('USNVC_compare_specieslists_loop_by_cluster.R')
Com.Structure[order(as.numeric(as.character(Com.Structure$cluster))),c("cluster", "association", "WetStructure")]
plotassociations[order(as.numeric(as.character(plotassociations$clust))),c("clust", "scientificname")]
substitutesymbols <- as.data.frame(cbind(SYMBOL2=c('2AG','TRBO2','SMLA3','CAREX'), form2=c('Nonvascular','Forb/Herb','Forb/Herb','Grass/grass-like (Graminoids)'), type2=c('Native','Native','Native','Native'), taxon=c('Chara','Lysimachia borealis','Smilax lasioneuron','Carex [ovales]')), stringsAsFactors = FALSE)
# data ----
Plant_Heights <- read.delim("data/Plant_Heights.txt", na.strings = '', stringsAsFactors = FALSE, encoding = 'UTF-8')
# # observed species means by plot ----
# Com.Sp.sum<-aggregate(obsspp[,c('Field', 'Shrub', 'Subcanopy', 'Tree', 'BA')], by=list(obsspp$Observation_ID, obsspp$Observation_Label, obsspp$AcTaxon, obsspp$Simple), FUN=sum) #sum within plot
# colnames(Com.Sp.sum)<-c('Observation_ID', 'Observation_Label', 'Species', 'Simple', 'Field', 'Shrub', 'Subcanopy', 'Tree', 'BA') #restore column names
# # freq in subplot ----
# Com.Sp.freq<-aggregate(obsspp[,c('AcTaxon')], by=list(obsspp$Observation_Label, obsspp$AcTaxon), FUN=length) #frequency within plot
# colnames(Com.Sp.freq)<- c('Observation_Label', 'Species', 'freq')
# Com.max.freq<-aggregate(Com.Sp.freq[,c('freq')], by=list(Com.Sp.freq$Observation_Label), FUN=max) #freq within plot
# colnames(Com.max.freq)<- c('Observation_Label', 'mfreq')
# Com.max.freq$mfreq<-ifelse(Com.max.freq$mfreq>4,4,Com.max.freq$mfreq)#effectively ensuring values do not exceed 4. Species listed 5 times might occur if surveyer was unaware of species already counted in subplots, but this only adds a trace amount.
# Com.Sp.mean<-merge(Com.Sp.sum, Com.max.freq[,c("Observation_Label","mfreq")], by="Observation_Label")
# Com.Sp.mean$Field<-Com.Sp.mean$Field/Com.Sp.mean$mfreq
# Com.Sp.mean$Shrub<-Com.Sp.mean$Shrub/Com.Sp.mean$mfreq
# Com.Sp.mean$Subcanopy<-Com.Sp.mean$Subcanopy/Com.Sp.mean$mfreq
# Com.Sp.mean$Tree<-Com.Sp.mean$Tree/Com.Sp.mean$mfreq
# rm(Com.max.freq)
# heights ----
#transfer canopy heights to appropriate stratum
#
obsspp <- obsspp %>% mutate(
Tmax = ifelse(
!is.na(Hmax) & Hmax > 15 & is.na(Tmax) & !grepl('^H',Habit), Hmax, Tmax),
Tmin = ifelse(
!is.na(Hmax) & Hmax > 15 & is.na(Tmin) & !grepl('^H',Habit), Hmin, Tmin),
SCmax = ifelse(
!is.na(Hmax) & Hmax > 5 & Hmax <= 15 & is.na(SCmax) & !grepl('^H',Habit), Hmax, SCmax),
SCmin = ifelse(
!is.na(Hmax) & Hmax > 5 & Hmax <= 15 & is.na(SCmin) & !grepl('^H',Habit), Hmin, SCmin),
Smax = ifelse(
!is.na(Hmax) & Hmax > 0.5 & Hmax <= 5 & is.na(Smax) & !grepl('^H',Habit), Hmax, Smax),
Smin = ifelse(
!is.na(Hmax) & Hmax > 0.5 & Hmax <= 5 & is.na(Smin) & !grepl('^H',Habit), Hmin, Smin),
Fmax = ifelse(
!is.na(Hmax) & Hmax > 0 & Hmax <= 0.5 & is.na(Fmax) | grepl('^H',Habit), Hmax, Fmax),
Fmin = ifelse(
!is.na(Hmax) & Hmax > 0 & Hmax <= 0.5 & is.na(Fmin) | grepl('^H',Habit), Hmin, Fmin))
Com.Sp.hts <- obsspp %>% group_by(Observation_Label, AcTaxon, Simple) %>%
summarise(
Fmin=mean(Fmin, na.rm=T),
Fmax=mean(Fmax, na.rm=T),
Smin=mean(Smin, na.rm=T),
Smax=mean(Smax, na.rm=T),
SCmin=mean(SCmin, na.rm=T),
SCmax=mean(SCmax, na.rm=T),
Tmin=mean(Tmin, na.rm=T),
Tmax=mean(Tmax, na.rm=T),
Dmin=mean(Dmin, na.rm=T),
Dmax=mean(Dmax, na.rm=T)
)
Com.Sp.mean.ht <- Com.Sp.mean %>% left_join(Com.Sp.hts, by=c('Observation_Label'='Observation_Label', 'Species'='AcTaxon', 'Simple'='Simple'))
#ensure not to exceed 100%
Com.Sp.mean.ht$Field <- ifelse(Com.Sp.mean.ht$Field > 100,100,Com.Sp.mean.ht$Field)
Com.Sp.mean.ht$Shrub <- ifelse(Com.Sp.mean.ht$Shrub > 100,100,Com.Sp.mean.ht$Shrub)
Com.Sp.mean.ht$Subcanopy <- ifelse(Com.Sp.mean.ht$Subcanopy > 100,100,Com.Sp.mean.ht$Subcanopy)
Com.Sp.mean.ht$Tree <- ifelse(Com.Sp.mean.ht$Tree > 100,100,Com.Sp.mean.ht$Tree)
#average overstory and understory
Com.Sp.mean.ht$Total <- 100*(1-10^(apply(log10(1-(Com.Sp.mean.ht[,c('Field', 'Shrub', 'Subcanopy', 'Tree')]/100.001)), MARGIN = 1, FUN='sum')))
Com.Sp.mean.ht <-subset(Com.Sp.mean.ht, !substr(Species,1,1) %in% '-'& !Species %in% '')
##cluster derived phases ----
groups1 <- as.data.frame(cbind(soilplot=names(groups), phase=groups))
Com.Sp.groups <- merge(groups1, Com.Sp.mean.ht, by='soilplot')
##average spp by phase ----
Com.Sp.groups.sum <- aggregate(Com.Sp.groups[,c('Field', 'Shrub', 'Subcanopy','Tree', 'Total')],
by=list(Com.Sp.groups$phase, Com.Sp.groups$Species), FUN='sum')
colnames(Com.Sp.groups.sum) <- c('phase', 'Species', 'Field', 'Shrub', 'Subcanopy','Tree', 'Total')
Com.Sp.groups.count <- aggregate(unique(Com.Sp.groups[c('phase', 'Observation_ID')])$Observation_ID,
by=list(unique(Com.Sp.groups[c('phase', 'Observation_ID')])$phase), FUN='length')
colnames(Com.Sp.groups.count) <- c('phase', 'count')
Com.Sp.groups.mean <- merge(Com.Sp.groups.sum, Com.Sp.groups.count, by = 'phase')
Com.Sp.groups.mean[,c('Field', 'Shrub', 'Subcanopy','Tree', 'Total')] <- Com.Sp.groups.mean[,c('Field', 'Shrub', 'Subcanopy','Tree', 'Total')]/Com.Sp.groups.mean$count
rm(Com.Sp.groups.sum, Com.Sp.groups.count)
# aggregated total overstory and understory for species ranking
Com.Sp.groups.mean$over <- 100*(1-10^(apply(log10(1-(Com.Sp.groups.mean[,c('Subcanopy', 'Tree')]/100.001)), MARGIN = 1, FUN='sum')))
Com.Sp.groups.mean$under <- 100*(1-10^(apply(log10(1-(Com.Sp.groups.mean[,c('Field', 'Shrub')]/100.001)), MARGIN = 1, FUN='sum')))
##average heights by phase ----
Com.Sp.groups.hts <- Com.Sp.groups %>% group_by(phase, Species, Simple) %>%
summarise(
Fmin=mean(Fmin, na.rm=T),
Fmax=mean(Fmax, na.rm=T),
Smin=mean(Smin, na.rm=T),
Smax=mean(Smax, na.rm=T),
SCmin=mean(SCmin, na.rm=T),
SCmax=mean(SCmax, na.rm=T),
Tmin=mean(Tmin, na.rm=T),
Tmax=mean(Tmax, na.rm=T),
Dmin=mean(Dmin, na.rm=T),
Dmax=mean(Dmax, na.rm=T)
)
Com.Sp.groups.hts <-  as.data.frame(Com.Sp.groups.hts)
View(Com.Sp.groups.hts)
for (i in 1:ncol(Com.Sp.groups.hts)){#i=3
Com.Sp.groups.hts[is.nan(Com.Sp.groups.hts[,i]),i] <- NA
}#clean up NaNs
##frequency spp by phase ----
Com.Sp.prefreq <- Com.Sp.groups
Com.Sp.prefreq$wt <- 1
Com.Sp.freq.sum <- aggregate(list(freq= Com.Sp.prefreq$Total),
by=list(Com.Sp.prefreq$phase, Com.Sp.prefreq$Species, Com.Sp.prefreq$wt), FUN='sum')
Com.Sp.groups.count <- aggregate(unique(Com.Sp.prefreq[c('phase','Observation_ID')])$wt,
by=list(unique(Com.Sp.prefreq[c('phase', 'Observation_ID')])$phase), FUN='sum')
Com.Sp.prefreq <- Com.Sp.groups
Com.Sp.prefreq$wt <- 1
Com.Sp.freq.sum <- aggregate(list(freq= Com.Sp.prefreq$Total),
by=list(Com.Sp.prefreq$phase, Com.Sp.prefreq$Species, Com.Sp.prefreq$wt), FUN='sum')
Com.Sp.groups.count <- aggregate(unique(Com.Sp.prefreq[c('phase','Observation_ID')])$wt,
by=list(unique(Com.Sp.prefreq[c('phase', 'Observation_ID')])$phase), FUN='sum')
unique(Com.Sp.prefreq[c('phase','Observation_ID')])$wt
Com.Sp.prefreq$wt <- 1
Com.Sp.prefreq <- Com.Sp.groups
Com.Sp.prefreq$wt <- 1
Com.Sp.freq.sum <- aggregate(list(freq= Com.Sp.prefreq$Total),
by=list(Com.Sp.prefreq$phase, Com.Sp.prefreq$Species, Com.Sp.prefreq$wt), FUN='sum')
Com.Sp.groups.count <- aggregate(unique(Com.Sp.prefreq[c('phase','Observation_ID')])$wt,
by=list(unique(Com.Sp.prefreq[c('phase', 'Observation_ID')])$phase), FUN='sum')
Com.Sp.prefreq
Com.Sp.prefreq[c('phase','Observation_ID')])$wt
unique(Com.Sp.prefreq[c('phase','Observation_ID')])$wt
Com.Sp.freq.sum
Com.Sp.prefreq <- Com.Sp.groups
Com.Sp.prefreq$wt <- 1
Com.Sp.freq.sum <- aggregate(list(freq= Com.Sp.prefreq$Total),
by=list(Com.Sp.prefreq$phase, Com.Sp.prefreq$Species, Com.Sp.prefreq$wt), FUN='sum')
unique(Com.Sp.prefreq[c('phase','Observation_ID')])$wt
Com.Sp.prefreq[c('phase','Observation_ID')]
groupplotsummary.R
Com.Sp.groups.mean
Com.Sp.groups
Com.Sp.groups.pctl <- ddply(Com.Sp.groups, c('phase', 'Species'), summarise,
f25 = quantile(Field, 0.15),
f75 = quantile(Field, 0.85),
s25 = quantile(Shrub, 0.15),
s75 = quantile(Shrub, 0.85),
sc25 = quantile(Subcanopy, 0.15),
sc75 = quantile(Subcanopy, 0.85),
t25 = quantile(Tree, 0.15),
t75 = quantile(Tree, 0.85),
b05 = quantile(BA, 0.05, na.rm = TRUE),
b95 = quantile(BA, 0.95, na.rm = TRUE)
)
Com.Sp.groups.pctl <- Com.Sp.groups %>% group_by(c(phase, Species)) %>% summarise(
f25 = quantile(Field, 0.15),
f75 = quantile(Field, 0.85),
s25 = quantile(Shrub, 0.15),
s75 = quantile(Shrub, 0.85),
sc25 = quantile(Subcanopy, 0.15),
sc75 = quantile(Subcanopy, 0.85),
t25 = quantile(Tree, 0.15),
t75 = quantile(Tree, 0.85),
b05 = quantile(BA, 0.05, na.rm = TRUE),
b95 = quantile(BA, 0.95, na.rm = TRUE)
)
Com.Sp.groups.pctl <- Com.Sp.groups %>% group_by(c(phase, Species)) %>% summarise(
f25 = quantile(Field, 0.15),
f75 = quantile(Field, 0.85),
s25 = quantile(Shrub, 0.15),
s75 = quantile(Shrub, 0.85),
sc25 = quantile(Subcanopy, 0.15),
sc75 = quantile(Subcanopy, 0.85),
t25 = quantile(Tree, 0.15),
t75 = quantile(Tree, 0.85),
b05 = quantile(BA, 0.05, na.rm = TRUE),
b95 = quantile(BA, 0.95, na.rm = TRUE)
)
Com.Sp.groups.pctl <- Com.Sp.groups %>% group_by(c('phase', 'Species')) %>% summarise(
f25 = quantile(Field, 0.15),
f75 = quantile(Field, 0.85),
s25 = quantile(Shrub, 0.15),
s75 = quantile(Shrub, 0.85),
sc25 = quantile(Subcanopy, 0.15),
sc75 = quantile(Subcanopy, 0.85),
t25 = quantile(Tree, 0.15),
t75 = quantile(Tree, 0.85),
b05 = quantile(BA, 0.05, na.rm = TRUE),
b95 = quantile(BA, 0.95, na.rm = TRUE)
)
Com.Sp.groups.pctl <- Com.Sp.groups %>% group_by(c(phase, Species)) %>% summarise(
f25 = quantile(Field, 0.15),
f75 = quantile(Field, 0.85)
# s25 = quantile(Shrub, 0.15),
# s75 = quantile(Shrub, 0.85),
# sc25 = quantile(Subcanopy, 0.15),
# sc75 = quantile(Subcanopy, 0.85),
# t25 = quantile(Tree, 0.15),
# t75 = quantile(Tree, 0.85),
# b05 = quantile(BA, 0.05, na.rm = TRUE),
# b95 = quantile(BA, 0.95, na.rm = TRUE)
)
View(Com.Sp.groups)
